<html xmlns="http://www.w3.org/1999/xhtml">    <head>        <title>Manage Products</title>        <style>            .panel-heading .btn-series {                vertical-align: top;                position: relative;                top: -3px;            }            #kpisTableBody .label{                margin-bottom: 3px;                display: inline-block;            }        </style>    </head>    <body class="">        #set( $yearNum = $formatter.toLong( $request.params.year, true ) )        #set( $startOfYear = $formatter.yearStart )        #if( $yearNum )            #set( $startOfYear = $formatter.newDate($yearNum, 0, 0) )        #else            #set( $yearNum = $formatter.getYear($startOfYear) )        #end        <div class="row">            <div class="col-sm-6">                <p>                    <button class="btn btn-danger" id="btnShowDeletePeriods">Delete KPI periods..</button>                    <button class="btn btn-info" id="btnShowProcessPeriods">Process KPI periods..</button>                    <button class="btn btn-success" id="btnShowAllocateRewards">Allocate KPI rewards..</button>                </p>            </div>            <div class="col-sm-6">                <div class="btn-group pull-right">                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">                        Year: $yearNum <span class="caret"></span>                    </button>                    <ul class="dropdown-menu">                        <li><a href="$page.href?year=2015">2015</a></li>                        <li><a href="$page.href?year=2016">2016</a></li>                    </ul>                </div>            </div>        </div>        <div style="display: none" id="deletePeriodsContainer">            <div class="alert alert-danger">                <h3>Delete KPI Periods</h3>                <p>Before deleting KPI periods please ensure:</p>                <ul>                    <li>You have deleted any points awarded by those KPIs</li>                    <li>Remaining KPI periods are contiguous, ie no gaps</li>                    <li>If data series are populated with triggers from points award from this KPI, you should have deleted those records</li>                </ul>                <br/>                <button class="btn btn-danger" id="btnDeletePeriods">Delete selected KPI periods</button>            </div>        </div>        <div style="display: none" id="processPeriodsContainer">            <div class="alert alert-info">                <h3>Process KPI Periods</h3>                <p>This will re-process selected KPI periods. It will calculate points to award, but not actually                    award or change any points. You can choose to apply changes to reward points after reviewing the KPI calculations.</p>                <br/>                <button class="btn btn-info" id="btnProcessPeriods">Process selected KPI periods</button>            </div>        </div>        <div style="display: none" id="allocateRewardsContainer">            <div class="alert alert-success">                <h3>Allocate KPI rewards</h3>                <p>This will allocate the points which have been calculated for each selected KPI period to participants. You can                    re-allocate points for periods which have previously had their rewards allocated, in which case previously allocated points                    for each KPI result will be negated, and the new value awarded.</p>                <br/>                <button class="btn btn-success" id="btnAllocateRewards">Allocate rewards for selected KPI periods</button>            </div>        </div>        <hr/>        #foreach($series in $page.find("/sales").children.ofType.series )            #set( $kpis = $series.child("kpis").children )            #if( !$kpis.isEmpty() )                <table class="table">                    <colgroup>                        <col style="width: 15%"/>                        <col style="width: 15%"/>                        <col style="width: 10%"/>                        <col style="width: 60%"/>                    </colgroup>                    <tbody id="kpisTableBody">                        <tr>                            <td colspan="99" class="info">                                <h3><a href="$series.href">$series.title</a></h3>                            </td>                        </tr>                        #set($lastSeriesDate = $page.lastDataDate(  $series ))                        <tr>                            #if( $lastSeriesDate )                                #set( $days = $formatter.durationDays( $startOfYear, $lastSeriesDate ) )                                #set( $perc = $formatter.toPercent($days, 365) )                                <td style="width: 150px" class="" colspan="2">                                    $series.numItems records,                                    last                                    $formatter.formatAge( $lastSeriesDate ) on $formatter.formatDate($lastSeriesDate)                                </td>                                <td class="" colspan="2">                                    <div title="$date" class="progress-bar progress-bar-$color" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: $perc; height: 20px">                                        <span class="">$perc</span>                                    </div>                                </td>                            #else                                <td colspan="4">                                    <span class="text-muted">No data has been loaded yet</span>                                </td>                                <td></td>                            #end                        </tr>                        #foreach($kpi in $kpis)                            <tr>                                <td rowspan="3">                                    <a href="$kpi.href">$kpi.name</a>                                    <br/>                                    $kpi.kpi.periodMultiples $kpi.kpi.frequency                                </td>                                <td rowspan="3" >                                    #foreach( $group in $kpi.selectedGroups )                                        <div class="label label-info">$group.name</div>                                    #end                                </td>                            </tr>                            <tr>                                #set( $periods = $kpi.kpi.findPeriodsSince( $startOfYear ) )                                #if( $periods.size() > 0 )                                    <td colspan="3">                                        <div style="position: relative; height: 40px">                                            #foreach($period in $periods )                                            #showPeriod($kpi $period $startOfYear)                                            #end                                        </div>                                    </td>                                #else                                    <td colspan="4"><span class="text-muted">No periods have been processed yet</span></td>                                #end                            </tr>                            #showProgress($page.lastPeriodDateWithRewards( $kpi.kpi ) "success" $startOfYear )                        #end                    </tbody>                </table>            #end        #end        #macro( showPeriod $kpi $period $startOfYear )            #set( $days = $formatter.durationDays( $period.startDate, $period.endDate ) )            #set( $perc = $formatter.toPercent($days, 365) )            #set( $startDays = $formatter.durationDays( $startOfYear, $period.startDate ) )            #set( $percLeft = $formatter.toPercent($startDays, 365) )            #set( $color = "warning" )                #if( $period.rewardsIssuedDate )            #set( $color = "success" )            #end            <div class="label label-$color" style="position: absolute; width: $perc; left: $percLeft; border: solid lightgrey 1px; overflow: hidden" title="Period ending $formatter.formatDate($period.endDate)" >                <input type="checkbox" value="$period.id" name="periodId" />                <a href="$kpi.href?period=$period.id#results-tab" target="_blank">                    $period.numRecords recs                </a>            </div>        #end        #macro( showProgress $date $color $startOfYear )            <tr>                #if( $date )                #set( $days = $formatter.durationDays( $startOfYear, $date ) )                #set( $perc = $formatter.toPercent($days, 365) )                <td colspan="2">                    <div style="">                        <div title="$date" class="progress-bar progress-bar-$color" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: $perc; height: 20px">                            <span class="">$perc</span>                        </div>                    </div>                </td>                #else                <td colspan="3">                    <span class="text-muted">No rewards have been allocated yet</span>                </td>                <td></td>                #end            </tr>        #end        <script type="text/javascript">            $(function (e) {                $("#btnShowDeletePeriods").click(function () {                    $("#deletePeriodsContainer").toggle(500);                });                $("#btnShowProcessPeriods").click(function () {                    $("#processPeriodsContainer").toggle(500);                });                $("#btnShowAllocateRewards").click(function () {                    $("#allocateRewardsContainer").toggle(500);                });                $("#btnDeletePeriods").click(function (e) {                    e.preventDefault();                    var checks = $("input[name=periodId]:checked");                    if (checks.length > 0) {                        if (confirm("Are you sure you want to delete " + checks.length + " periods?")) {                            doDeletePeriods(checks);                        }                    } else {                        Msg.error("Please select KPI periods to delete");                    }                });                $("#btnProcessPeriods").click(function (e) {                    e.preventDefault();                    var checks = $("input[name=periodId]:checked");                    if (checks.length > 0) {                        if (confirm("Are you sure you want to process " + checks.length + " periods?")) {                            doProcessPeriods(checks);                        }                    } else {                        Msg.error("Please select KPI periods to process");                    }                });                $("#btnAllocateRewards").click(function (e) {                    e.preventDefault();                    var checks = $("input[name=periodId]:checked");                    if (checks.length > 0) {                        if (confirm("Are you sure you want to allocate rewards for " + checks.length + " periods?")) {                            doPeriodsCommand("allocate", checks);                        }                    } else {                        Msg.error("Please select KPI periods to allocate rewards for");                    }                });            });            function doDeletePeriods(checks) {                doPeriodsCommand("delete", checks);            }            function doProcessPeriods(checks) {                doPeriodsCommand("process", checks);            }            function doPeriodsCommand(command, checks) {                flog("doPeriodsCommand", command, checks);                var periodIds = "";                checks.each(function () {                    periodIds += $(this).val() + ",";                });                var data = {                    command: command,                    periodId: periodIds                };                $.ajax({                    type: 'POST',                    url: window.location.pathname,                    dataType: "json",                    data: data,                    success: function (data) {                        flog("response", data);                        if (!data.status) {                            Msg.error("Failed to " + command + " periods: " + data.mssages);                        } else {                            Msg.info(command + "ed periods");                            $("#kpisTableBody").reloadFragment();                        }                    },                    error: function (resp) {                        flog("error", resp);                        Msg.error("An error occured " + command + "ing KPI periods");                    }                });            }        </script>    </body></html>