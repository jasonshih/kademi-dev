<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Manage Sales Data Series</title>
        <style>
            .DateTimeIcon {
                display: none;
            }

            .upload-results {
                display: none;
            }
        </style>
        <script type="text/javascript" src="manageKpi.js">//</script>
        <script type="text/javascript" src="jquery.kpiVis.js">//</script>
        <script src="/static/d3/d3.v3.js" type="text/javascript">//</script>
        <link href="/static/nvd3/nv.d3.css" rel="stylesheet" type="text/css" />
        <script src="/static/nvd3/nv.d3.js" type="text/javascript">//</script>

    </head>
    <body class="">

        <form name="frmDetails" action="." method="post" class="form-horizontal kpi-form">
            <div class="pull-right page-action">
                <div class="btn-group">
                    <button class="btn btn-sm btn-danger kpi-process" type="button">
                        <span class="glyphicon glyphicon-signal"></span>
                        Process KPIs
                    </button>
                    <button type="button" class="btn btn-danger btn-sm dropdown-toggle" data-toggle="dropdown">
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu pull-right" role="menu">
                        <li class="presentation" role="menuitem"><a href="#" data-toggle="modal" data-target="#modal-reprocess"><i class="fa fa-refresh"></i> Reprocess</a></li>
                    </ul>
                </div>
                <button class="btn btn-sm btn-success" type="submit">
                    <span class="fa fa-save"></span>
                    Save changes
                </button>
            </div>

            <div class="tabbable">
                <ul class="nav nav-tabs tab-bricky">
                    <li><a data-toggle="tab" href="#general">General</a></li>
                    <li><a data-toggle="tab" href="#config">Configuration</a></li>
                    <li><a data-toggle="tab" href="#levels">Rewards & Levels</a></li>
                    <li><a data-toggle="tab" href="#criteria">Criteria</a></li>
                    <li><a data-toggle="tab" href="#notes">Notes</a></li>
                    <li><a data-toggle="tab" href="#history">History</a></li>
                    <li><a data-toggle="tab" href="#results">Results</a></li>
                    <li><a data-toggle="tab" href="#query">Query</a></li>
                    <li><a data-toggle="tab" href="#leaderboard">Leaderboard</a></li>
                </ul>
                <div class="tab-content">
                    <div id="general" class="tab-pane">
                        <p class="lead" id="configSummary">
                            #if( $page.kpi.aggregation )
                            <b>$page.kpi.aggregation</b> values in <b>$page.parent.title</b> every <b>$page.kpi.periodMultiples $page.kpi.frequency</b>,
                            for users in groups
                            #foreach( $group in $page.selectedGroups)
                            <b>$group.name</b>,
                            #end
                            starting $formatter.formatDateTime($page.kpi.startDate, $page.organisation.timezone)
                            #else
                            <b>This KPI has not been configured yet</b>
                            #end
                        </p>
                        <hr />
                        <div class="form-group">
                            <div class="col-xl-8 col-lg-8 col-md-8 col-sm-12">
                                <div id="seriesHistogram" style="height: 480px">
                                    <svg></svg>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div>
                                    <table class="table table-bordered table-striped" id="kpiLeaderboard">
                                        <thead>
                                            <tr>
                                                <th colspan="2">Leaderboard</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <th colspan="2"><i>Loading...</i></th>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div id="config" class="tab-pane">
                        <div class="form-group">
                            <label class="control-label col-md-3" for="title">Title</label>

                            <div class="col-md-9">
                                <input type="text" name="title" id="title" value="$!page.kpi.title" placeholder="" class="required form-control" required="true" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-3" for="title">Identifier</label>

                            <div class="col-md-3">
                                <input type="text" name="name" id="name" value="$!page.kpi.name" placeholder="" class="required form-control" required="true" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-3" for="aggregation">
                                Aggregation
                                <small>How should values be merged over the KPI period</small>
                            </label>

                            <div class="col-md-3">
                                <select name="aggregation" id="aggregation" class="form-control required" required="true">
                                    <option value="">[Not selected]</option>
                                    #foreach($agg in $page.aggregationTypes.entrySet() )
                                    $formatter.option($agg.key, $agg.value, $page.kpi.aggregation)
                                    #end
                                </select>
                            </div>
                            <label class="control-label col-md-3" for="searchUp">
                                Search direction
                                <small>Select true for data where more is better (ie sales), and select false when less is better (ie num complaints)</small>
                            </label>

                            <div class="col-md-3">
                                <select name="searchUp" id="searchUp" class="form-control required">
                                    $formatter.option("true", "Up - higher is better", $page.searchUp)
                                    $formatter.option("false", "Down - lower is better", $page.searchUp)
                                </select>
                            </div>
                        </div>


                        <div class="form-group">
                            <label class="control-label col-md-3" for="notes">
                                Aggregation period
                                <small>Over what period should criteria be assessed?</small>
                            </label>

                            <div class="col-md-3 col-sm-4 col-xs-12">
                                <div class="input-group pull-left">
                                    <input type="text" class="text-center form-control" value="$!page.kpi.periodMultiples" name="periodMultiples" />

                                    <div class="input-group-btn">
                                        <button data-toggle="dropdown" class="btn btn-default dropdown-toggle timer-unit" type="button">$!page.kpi.frequency
                                            <span class="caret"></span></button>
                                        <ul role="menu" class="dropdown-menu pull-right timer-units">
                                            #foreach($unit in $page.allFrequencies)
                                            <li><a href="#">$unit</a></li>
                                            #end
                                        </ul>
                                    </div>
                                    <input type="hidden" name="frequency" class="timer-unit" value="$!page.kpi.frequency" />
                                </div>
                            </div>

                            <label class="control-label col-md-3" for="orderingField">
                                Ordering
                                <small>In what order should the KPI's be listed</small>
                            </label>

                            <div class="col-md-3">
                                <input type="text" name="orderingField" placeholder="Ordering" value="$!page.orderingField" class="form-control numeric" />
                            </div>
                        </div>


                        <div class="form-group">
                            <label class="control-label col-md-3" for="aggregation">
                                Baseline
                                <small>Should KPI results be determined from a baseline</small>
                            </label>

                            <div class="col-md-3">
                                <select name="baselineType" id="baselineType" class="form-control">
                                    <option value="">[Not selected]</option>
                                    #foreach($agg in $page.baselineTypes.entrySet() )
                                    $formatter.option($agg.key, $agg.value, $page.kpi.baselineType)
                                    #end
                                </select>
                            </div>

                            <label class="control-label col-md-3" for="aggregation">
                                Baseline series
                                <small>Select a series which contains baseline targets</small>
                            </label>

                            <div class="col-md-3">
                                <select name="baselineSeries" id="baselineSeries" class="form-control" >
                                    <option value="">[Not selected]</option>
                                    #foreach($ds in $page.find("/sales").children)
                                    $formatter.option( $ds.name,$ds.title, $page.kpi.baselineSeries.name )
                                    #end
                                </select>
                            </div>
                        </div>



                        <div class="form-group">
                            <label class="control-label col-md-3" for="startDate">
                                Start date
                                <small>Date of the first assessment period</small>
                            </label>

                            <div class="col-md-3">
                                <div class="input-group">
                                    <input type="text" name="startDate" placeholder="Start date" data-format="DD/MM/YYYY" value="$formatter.formatDate($!page.kpi.startDate)" class="form-control DateTime" />
                                    <span class="input-group-addon"> <i class="fa fa-calendar"></i> </span>
                                </div>
                            </div>

                            <label class="control-label col-md-3" for="endDate">
                                End date
                            </label>

                            <div class="col-md-3">
                                <div class="input-group">
                                    <input type="text" name="endDate" placeholder="End date" data-format="DD/MM/YYYY" value="$formatter.formatDate($!page.kpi.endDate)" class="form-control DateTime" />
                                    <span class="input-group-addon"> <i class="fa fa-calendar"></i> </span>
                                </div>
                            </div>
                        </div>

                        <hr />

                        <h2>Groups</h2>

                        <div class="alert alert-info">
                            <p>The KPI will only users who belong to ALL of the selected groups</p>
                        </div>
                        <table class="">
                            #foreach($g in $page.allGroups)
                            <tr>
                                <td>
                                    <div class="col-sm-offset-3">
                                        <label class="checkbox-inline">
                                            $formatter.checkbox("appliesToGroupIds", "appliesToGroupIds", $page.isSelected($g), $g.id ) $g.name
                                        </label>
                                    </div>
                                </td>
                            </tr>
                            #end
                        </table>

                    </div>

                    <div id="notes" class="tab-pane">  <!-- notes -->
                        <small>For internal use.</small>
                        <textarea cols="100" name="notes" id="notes" rows="20" placeholder="" class="form-control">$!page.kpi.notes</textarea>
                    </div>
                    <!-- end notes -->

                    <div id="criteria" class="tab-pane">  <!-- criteria -->
                        <div class="form-group">
                            <label class="control-label col-md-3" for="field1">
                                Field 1
                            </label>

                            <div class="col-md-8">
                                <input type="text" name="field1" value="$!page.kpi.field1" class="form-control" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3" for="field2">
                                Field 2
                            </label>

                            <div class="col-md-8">
                                <input type="text" name="field2" value="$!page.kpi.field2" class="form-control" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3" for="field3">
                                Field 3
                            </label>

                            <div class="col-md-8">
                                <input type="text" name="field3" value="$!page.kpi.field3" class="form-control" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3" for="field4">
                                Field 4
                            </label>

                            <div class="col-md-8">
                                <input type="text" name="field4" value="$!page.kpi.field4" class="form-control" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3" for="field5">
                                Field 5
                            </label>

                            <div class="col-md-8">
                                <input type="text" name="field5" value="$!page.kpi.field5" class="form-control" />
                            </div>
                        </div>

                        <hr />
                        <div class="form-group">
                            <label class="control-label col-md-3" for="tags">
                                Tags
                            </label>

                            <div class="col-md-8">
                                <input type="text" name="tags" value="$!page.kpi.tags" class="form-control" />
                            </div>
                        </div>


                    </div>
                    <!-- end criteria -->

                    <div id="levels" class="tab-pane"> <!-- levels -->
                        <div class="form-group">
                            <label class="control-label col-md-3" for="reward">
                                Reward
                            </label>

                            <div class="col-md-8">
                                <select name="reward" id="reward" class="form-control">
                                    <option value="">[No points]</option>
                                    #foreach($reward in $page.rewards)
                                    $formatter.option($reward.name, $reward.title, $page.kpi.reward.name)
                                    #end
                                </select>

                                <p>
                                    <small>To allocate points for achieving levels, select the reward here</small>
                                </p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-3" for="pointsTag">
                                Tag
                                <small>Tag the allocated points</small>
                            </label>

                            <div class="col-md-8">
                                <select name="pointsTag" id="pointsTag" class="form-control">
                                    <option value="">[No tag]</option>
                                    #foreach($tag in $page.pointsTag)
                                    $formatter.option($tag.name, $tag.title, $page.kpi.pointsTag.name)
                                    #end
                                </select>

                                <p>
                                    <small>To tag the allocated points, select a tag here</small>
                                </p>
                            </div>
                        </div>

                        <div class="well">
                            <div class="form-group">
                                <label class="control-label col-md-3" for="reward">
                                    Top achievers
                                    <small>Allocate points to the top achievers in this KPI</small>
                                </label>

                                <div class="col-md-8">
                                    <input type="text" name="numTopAchievers" id="numTopAchievers" value="$!page.kpi.numTopAchievers" placeholder="How many of the top achievers" class="form-control" />
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="control-label col-md-3" for="reward">
                                    Points
                                    <small>MVEL expression for how many points to award top achievers</small>
                                </label>

                                <div class="col-md-8">
                                    <input type="text" name="topAchieverPointsExpr" id="topAchieverPointsExpr" value="$!page.kpi.topAchieverPointsExpr" placeholder="A number or expression for the number of points to award" class="form-control" />
                                    <i>Eg: amount * 10</i>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <p>Create levels for this data series to reward your users when they achieve certain threshholds.</p>
                        </div>

                        <div>
                            <div class="btn-group btn-group-sm">
                                <a href="#" class="btn btn-sm btn-success btn-sm btn-add-level">
                                    <i class="fa fa-plus"></i> Add new Level
                                </a>
                                <button class="btn btn-sm btn-success btn-sm dropdown-toggle" data-toggle="dropdown">
                                    <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu pull-right" role="menu">
                                    <li><a href="#" title="importCSV" id="uploadKpiCsv"><i class="glyphicon glyphicon-upload"></i> Upload CSV</a></li>
                                    <li class="divider"></li>
                                    <li><a href="kpiLevels.csv" title="exportCSV"><i class="glyphicon glyphicon-download"></i> Export CSV</a></li>
                                </ul>
                            </div>
                        </div>
                        <hr />
                        <table class="table table-bordered table-striped">
                            <colgroup>
                                <col />
                                <col />
                                <col />
                                <col />
                                <col style="width: 120px" />
                            </colgroup>
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Title</td>
                                    <th>Threshold</th>
                                    <th>Reward points</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="levels-table-body">
                                #if( $page.kpi.levels.size() > 0 )
                                #foreach( $level in $page.kpi.levels)
                                <tr id="level-${level.id}">
                                    <td>$level.name</td>
                                    <td>$level.title</td>
                                    <td>
                                        #if($level.minorBoundFromSeries)
                                        #if($level.minorBound)
                                        <b>$level.minorBound%</b> of
                                        participants value in <b><a href="../../../$level.minorBoundFromSeries.name">$level.minorBoundFromSeries.title</a></b>
                                        #else
                                        Find Participants value in <b><a href="../../../$level.minorBoundFromSeries.name">$level.minorBoundFromSeries.title</a></b>
                                        #end

                                        #elseif($level.minorBound)
                                        $level.minorBound
                                        #else
                                        <span class="label label-danger">No threshhold set</span>
                                        #end
                                    </td>
                                    <td>
                                        $!level.awardAmount
                                        $!level.awardAmountExpr
                                    </td>
                                    <td class="action">
                                        <div class="btn-group btn-group-sm">
                                            <a href="$level.id .edit-form" class="btn btn-sm btn-info btn-edit-level" data-toggle="modal" data-target="#editLevelModal"><i class="fa fa-cog"></i> Edit</a>
                                            <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-toggle="dropdown">
                                                <span class="caret"></span>
                                                <span class="sr-only">Toggle Dropdown</span>
                                            </button>
                                            <ul role="menu" class="dropdown-menu pull-right">
                                                <li><a class="btn-remove-level" href="$level.id"><i class="glyphicon glyphicon-remove"></i> Delete</a></li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                #end
                                #else
                                <tr>
                                    <td colspan="3">There are no KPI levels defined yet</td>
                                </tr>
                                #end
                            </tbody>
                        </table>
                    </div>
                    <!-- end levels -->


                    <div id="history" class="tab-pane">

                        <div class="pull-right">
                            <button type="button" class="btn btn-sm btn-default periods-delete">
                                <span class="glyphicon glyphicon-remove"></span>
                                Delete
                            </button>
                        </div>
                        <br />

                        <p>KPI start date: starting $formatter.formatDateTime($page.kpi.startDate, $page.organisation.timezone) </p>

                        <table class="table table-bordered table-striped" id="table-periods">
                            <colgroup>
                                <col width="" />
                                <col width="" />
                                <col width="" />
                                <col width="" />
                                <col data-sort="false" width="30px" />
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>Start</th>
                                    <th>End</th>
                                    <th>Processed date</th>
                                    <th>Rewards issued date</th>
                                    <th><input type="checkbox" name="deletePeriodId" class="chk-all" /></th>
                                </tr>
                            </thead>
                            <tbody>
                                #foreach($period in $page.periods)
                                <tr>
                                    <td>$formatter.formatDateTime($period.startDate, $page.organisation.timezone)</td>
                                    <td>$formatter.formatDateTime($period.endDate, $page.organisation.timezone)</td>
                                    <td>$formatter.formatDateTime($period.createdDate, $page.organisation.timezone)</td>
                                    <td>
                                        #if( $period.rewardsIssuedDate )
                                        $formatter.formatDateTime($period.rewardsIssuedDate, $page.organisation.timezone)
                                        #else
                                        <span class="label label-danger">Rewards not issued</span>
                                        #end
                                    </td>
                                    <td>
                                        <input type="checkbox" class="deletePeriodId" value="$period.id" />
                                    </td>
                                </tr>
                                #end
                            </tbody>
                        </table>
                    </div>

                    <div id="results" class="tab-pane">
                        #set( $selPeriodId = $formatter.toLong( $request.params.period, true ) )
                        #if( $selPeriodId )
                        #set( $selPeriod = $page.kpi.period( $selPeriodId ) )
                        #else
                        #set( $selPeriod = $page.lastPeriod )
                        #end

                        <div class="row">
                            <div class="col-md-9">
                                <h3>Assessed results for $formatter.formatDate($selPeriod.startDate) to $formatter.formatDate($selPeriod.endDate)</h3>
                                #if( $selPeriod.rewardsIssuedDate )
                                <div class="alert alert-success">
                                    Rewards allocated $formatter.formatAge( $selPeriod.rewardsIssuedDate )
                                </div>
                                #else
                                <div class="alert alert-danger">
                                    Rewards have not been allocated yet
                                </div>
                                #end
                                <div class="clearfix">
                                    <button type="button" class="btn btn-sm btn-danger pull-right btn-del-kpiresult"><i class="fa fa-trash"></i></button>
                                    <br />
                                    <br />
                                </div>
                                <table id="table-results" class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>Participant</th>
                                            <th>Achievement Level</th>
                                            <th>Achievement Amount</th>
                                            <th>Raw amount</th>
                                            <th>Baseline</th>
                                            <th>Level threshhold</th>
                                            <th>Points Assessed</th>
                                            <th>Points Awarded</th>
                                            <th class="text-center">
                                                <input type="checkbox" name="sel-kpiResult" class="selectAll" />
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        #foreach($result in $page.results($selPeriod) )
                                        <tr data-id="$result.id">
                                            <td>
                                                <a href="/manageUsers/$result.participant.id">
                                                    $result.participant.formattedName ($result.participant.name)
                                                </a>

                                            </td>
                                            <td>$!result.level.title</td>
                                            <td>$formatter.formatCurrency( $result.amount )</td>
                                            <td>$!formatter.formatCurrency( $result.rawAmount )</td>
                                            <td>$!formatter.formatCurrency( $result.baselineAmount )</td>
                                            <td>$!formatter.formatCurrency( $result.levelAmount )</td>
                                            <td>$!result.awardedPoints</td>
                                            <td>
                                                #set( $actualPoints = false )
                                                #set( $actualPoints = $result.actualAwardedPoints.numPoints )
                                                #if( $actualPoints )
                                                $actualPoints
                                                #if( $actualPoints > $result.awardedPoints )
                                                #set( $diff = $result.awardedPoints - $actualPoints )
                                                <span class="label label-danger">$diff</span>
                                                #elseif( $actualPoints < $result.awardedPoints )
                                                #set( $diff = $result.awardedPoints - $actualPoints )
                                                <span class="label label-success">$diff</span>
                                                #end
                                                #end
                                            </td>

                                            <td class="text-center">
                                                <input type="checkbox" name="sel-kpiResult" />
                                            </td>
                                        </tr>
                                        #end
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-3">
                                <h3>Assessment periods</h3>
                                <button class="btn btn-sm btn-success kpiRewards" type="button" data-periodId="$selPeriod.id">
                                    <span class="fa fa-dollar"></span>
                                    Allocate rewards for selected period
                                </button>

                                <hr />

                                <ul class="list-group">
                                    #foreach($period in $page.periods)

                                    #set( $active = "" )
                                    #if( $period.id == $selPeriod.id )
                                    #set( $active = "active" )
                                    #end
                                    <a class="list-group-item $active" href="?period=$period.id#results-tab">
                                        <span class="badge">$period.numResults</span>

                                        #if( $period.rewardsIssuedDate )
                                        <span class="fa fa-trophy"></span>
                                        #end

                                        $formatter.formatDate($period.startDate) - $formatter.formatDate($period.endDate)
                                    </a>
                                    #end
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div id="query" class="tab-pane">
                        <p>Query for progress results for a participant for a given date period</p>

                        <div class="input-group col-md-4">
                            <label for="data-query" class="input-group-addon">Search</label>
                            <input type="text" id="data-query" placeholder="Search" value="" class="form-control" />
                        </div>

                        <div class="clearfix"></div>
                        <hr />

                        <div id="queryResults">
                            #if( $page.queryMessage )
                            <div class="alert alert-info">
                                $page.queryMessage
                            </div>
                            #end

                            #if( $page.queryRecords )
                            <table class="table table-striped">
                                <tr>
                                    <th>Partipiant</th>
                                    <td colspan="2">
                                        <a href="/manageUsers/$page.queryProfile.userId">$page.queryProfile.userName</a>
                                    </td>
                                </tr>

                                <tr>
                                    <th>Progress</th>
                                    <td colspan="2">
                                        #set( $prog = $page.getProgress( $page.queryProfile, $page.queryStart, $page.queryFinish ) )
                                        #if( $prog )
                                        $formatter.formatNumeric($prog)
                                        #else
                                        Could not locate a progress value
                                        #end
                                    </td>
                                </tr>
                                <tr>
                                    <th>Period start</th>
                                    <td colspan="2">$!page.queryStart</td>
                                </tr>
                                <tr>
                                    <th>Period end</th>
                                    <td colspan="2">
                                        #set($periodEndDate = $page.getPeriodEndDate( $page.queryStart ))
                                        $!periodEndDate
                                    </td>
                                </tr>
                                <tr>
                                    <th>Progress end</th>
                                    <td colspan="2">
                                        $!page.queryFinish
                                    </td>
                                </tr>
                                <tr>
                                    <th>Elapsed duration</th>
                                    <td colspan="2">
                                        #set( $perc = $page.getPeriodElapsedPerc( $page.queryStart, $periodEndDate, $page.queryFinish ) )
                                        $formatter.formatNumeric( $perc )
                                    </td>
                                </tr>
                                <tr>
                                    <th>Level</th>
                                    <td colspan="2">
                                        #set( $level = false)
                                        #set( $level = $page.progressLevel( $page.queryProfile, $page.queryStart, $page.queryFinish ) )
                                        #if( $level )
                                        <span class="badge badge-info">$level.levelName</span>
                                        Actual = $formatter.formatNumeric($level.actual) vs target $formatter.formatNumeric($level.target)
                                        #else
                                        Did not meet any levels
                                        #end
                                    </td>

                                </tr>
                            </table>

                            <p class="lead">Level thresholds</p>

                            <p>List of all levels, with the target values as calculated for the selected user, and the percentage of that level the current KPI value represents</p>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Level name</th>
                                        <th>Level target</th>
                                        <th>Percentage achieved</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    #foreach($levelName in $page.levelNames)
                                    <tr>
                                        <th>$levelName</th>
                                        <td>
                                            #set( $l = $page.getTargetForLevel( $page.queryProfile, $levelName, $page.queryStart, $page.queryFinish ))
                                            #if( $l )
                                            $formatter.formatNumeric($l)
                                            #else
                                            Could not locate a target for this level
                                            #end

                                        </td>
                                        <td>
                                            #set( $level = false)
                                            #set( $level = $page.getProgressOfLevelPerc( $page.queryProfile, $levelName, $page.queryStart, $page.queryFinish ) )
                                            $formatter.formatNumeric($level) %
                                        </td>

                                    </tr>
                                    #end
                                </tbody>
                            </table>

                            <hr />

                            <h2>Matched records</h2>
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Amount</th>
                                        <th>Sales by</th>
                                        <th>Entered</th>
                                        <th>By</th>
                                        <th colspan="2">Sales Period</th>
                                        #foreach($field in $page.extraFieldNames)
                                        <th>$field</th>
                                        #end
                                        <th><input type="checkbox" name="toRemoveId" class="chk-all" value="" /></th>
                                    </tr>
                                </thead>
                                <tbody id="history-table-body">
                                    #foreach($item in $page.queryRecords)
                                    <tr>
                                        <td>
                                            #if( $item.amount )
                                            $item.amount
                                            #else
                                            No value
                                            #end
                                        </td>
                                        <td>
                                            <!-- either a profilebean or orgdata -->
                                            #if( $item.salesBy.name ) <!-- is individual -->
                                            <a href="/manageUsers/$item.salesBy.userId">$item.salesBy.name ($item.salesBy.userName)</a>
                                            #else
                                            <a href="/manageOrgs/$item.salesBy.orgId">$item.salesBy.title</a>
                                            #end
                                        </td>
                                        <td>
                                            <abbr title="$formatter.formatDateISO8601($item.enteredDate)" class="timeago">$!item.enteredDate</abbr>
                                        </td>
                                        <td><a href="/manageUsers/$item.enteredBy.userId">$item.enteredBy.name</a></td>
                                        <td title="$formatter.formatDateISO8601($item.periodTo)">$formatter.formatDateTime($item.periodFrom, $page.organisation.timezone)</td>
                                        <td title="$formatter.formatDateISO8601($item.periodTo)">$formatter.formatDateTime($item.periodTo, $page.organisation.timezone)</td>
                                        #foreach($field in $page.extraFieldNames)
                                        <td>$!item.extraFields.get( $field )</td>
                                        #end
                                        <td><input type="checkbox" name="toRemoveId" value="$item.id" /></td>
                                    </tr>
                                    #end
                                </tbody>
                            </table>
                            #else
                            <div class="alert alert-info">Query did not match any records</div>
                            #end
                        </div>
                    </div>
                    <div id="leaderboard" class="tab-pane">
                        <p>Generate a leaderboard for this KPI over the currently selected date range</p>

                        <button class="btn btn-info" id="runLeaderboard">
                            <span class="glyphicon glyphicon-play-circle"></span>
                            Query
                        </button>

                        <div class="clearfix"></div>
                        <hr />

                        <div id="leaderboardResults">
                            #if( $request.params.leaderboard )
                            #set( $startDate = $page.startDate )
                            #set( $endDate = $page.finishDate )
                            #set( $lb = $page.getLeaderboard($startDate, $endDate))
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Amount</th>
                                        <th>Raw value</th>
                                        <th>Baseline</th>
                                        <th>Participant</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboardBody">
                                    #foreach($item in $lb.highestResults )
                                    #set( $plusOne = $item.rank + 1 )
                                    <tr>
                                        <td>$plusOne</td>
                                        <td>
                                            #if( $item.amount )
                                            $item.amount
                                            #else
                                            No value
                                            #end
                                        </td>
                                        <td>$!item.rawAmount</td>
                                        <td>$!item.baseline</td>
                                        <td>
                                            <!-- either a profilebean or orgdata -->
                                            #if( $item.profile) <!-- is individual -->
                                            <a href="/manageUsers/$item.profile.userId">$item.profile.name ($item.profile.userName)</a>
                                            #else
                                            <a href="/manageOrgs/$item.org.orgId">$item.org.title</a>
                                            #end
                                        </td>
                                        <td>
                                            #if( $item.profile)
                                            #foreach($orgAndGroup in $item.profile.primaryMemberships().groupByOrg.entrySet() )
                                            <span class="label label-success">
                                                <b>$orgAndGroup.value.first.groupName</b>
                                                in
                                                $orgAndGroup.key.title
                                            </span>
                                            #end
                                            #end
                                        </td>
                                    </tr>
                                    #end
                                </tbody>
                            </table>
                            #else
                            <p>Press the query button above to generate the leaderboard</p>
                            #end
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <div id="editLevelModal" class="modal fade level-modal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="panel-body text-center lead h2">Loading...</div>
                </div>
            </div>
        </div>

        <div id="modal-reprocess" class="modal fade" aria-hidden="true" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="." method="POST" class="form-horizontal">
                        <input type="hidden" name="reprocess" value="reprocess" />

                        <div class="modal-header">
                            <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>
                            <h4 class="modal-title">Reprocess period</h4>
                        </div>
                        <div class="modal-body">
                            <p>
                                This will re-generate KPI assessments and calculated points which should be awarded. This will not by itself
                                create or change points.
                            </p>
                            <div class="form-message alert alert-danger" style="display: none;"></div>

                            <div class="form-group">
                                <label class="col-md-3 control-label" for="users">Users
                                    <small>Username or email address, one per line.</small>
                                </label>

                                <div class="col-md-8">
                                    <textarea name="users" class="form-control" rows="4"></textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-3 control-label" for="period">Period</label>

                                <div class="col-md-8">
                                    <select name="period" class="form-control required">
                                        $formatter.option("", "Please select a period", null)
                                        #foreach($period in $page.periods)
                                        #set($pName = $formatter.formatDate($period.startDate) + ' - ' + $formatter.formatDate($period.endDate))
                                        $formatter.option($period.id, $pName, null)
                                        #end
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>
                            <button class="btn btn-sm btn-primary" type="submit">Process</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


        <div id="modal-upload-csv" class="modal fade" aria-hidden="true" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>
                        <h4 class="modal-title">Upload KPI Level CSV</h4>
                    </div>
                    <div class="modal-body">
                        <div class="upload">
                            <div class="btn-upload" id='do-upload-csv'></div>
                            <br />
                            <!--
                            <div class="allow-inserts">
                                <input type="checkbox" id="allow-inserts" /> <label for="allow-inserts">Allow inserts</label>
                            </div>
                            -->
                        </div>
                        <br />

                        <div class="upload-results">
                            <p>
                                <strong>No. inserted:</strong>
                                <span class="badge badge-success num-inserted">-</span>
                                <strong>No. updated:</strong>
                                <span class="badge badge-success num-updated">-</span>
                                <strong>Unmatched rows:</strong>
                                <span class="badge badge-danger num-unmatched">-</span>
                            </p>

                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-condensed">
                                    <tbody>
                                        <tr>
                                            <td></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript" src="/static/js/jquery.milton-upload.js"></script>
        <script type="text/javascript">
            $(function () {
                var pageName = getFileName(window.location.pathname);
                setRecentItem(document.title + " (" + pageName + ")", window.location.pathname);
                var kpiName = "$page.kpi.name";
                $(".timeago").timeago();
                $(".timer-units li").click(function (e) {
                    e.preventDefault();
                    var unit = $(e.target).text();
                    $(".timer-unit").text(unit).val(unit);
                });
                var kpiForm = $("form.kpi-form");
                kpiForm.forms({
                    validate: function (form) {
                        var extraCriteria = form.find('textarea[name=extraCriteria]');
                        var eVal = extraCriteria.val();

                        var eDom = $(eVal);

                        if (eDom.length > 0) {
                            var newVal = xml2string(eDom[0]);

                            flog('extraCriteria value', newVal);

                            extraCriteria.val(newVal)
                        }
                        return true;
                    },
                    callback: function (resp) {
                        if (resp.status) {
                            Msg.info("Saved ok");
                            if (kpiForm.find("#name").val() != kpiName) {
                                window.location.href = "../" + kpiForm.find("#name").val();
                            } else {
                                $("#configSummary").reloadFragment();
                            }
                        } else {
                            Msg.error("An error occured saving: " + resp);
                        }
                    }
                });

                $(".kpi-process").click(function (e) {
                    e.preventDefault();
                    if (confirm("This will generate assessed levels for each un-processed period. Are you sure you want to continue?")) {
                        submitProcess("processKpis");
                    }
                });
                $(".kpiRewards").click(function (e) {
                    e.preventDefault();
                    var periodId = $(e.target).data("periodId");
                    if (confirm("This will allocate rewards based on KPI achievements for results which have not already had rewards processing. Would you like to continue?")) {
                        submitProcess("processRewards", periodId);
                    }
                });

                var editLevelModal = $("#editLevelModal");

                $(".btn-add-level").click(function (e) {
                    e.preventDefault();
                    var newName = prompt("Please enter a name for the new level, you can then edit the details");
                    if (newName != null) {
                        createLevel(newName);
                    }
                });

                editLevelModal.on('hidden.bs.modal', function () {
                    editLevelModal.find('.modal-content').html('<div class="panel-body text-center lead h2">Loading...</div>');
                    editLevelModal.removeData('bs.modal');
                });

                $(document).on('loaded.bs.modal', ".level-modal", function (e) {
                    flog("loaded");
                    editLevelModal.find("form").forms({
                        callback: function (resp) {
                            if (resp.status) {
                                Msg.info("Saved level");
                                $("#levels-table-body").reloadFragment();
                                editLevelModal.modal("hide");
                            } else {
                                Msg.error("An error occured saving: " + resp);
                            }
                        }
                    });
                    editLevelModal.find(".selectVal").on('click', function (e) {
                        var type = $(this).val();
                        var fixed = $(".fixed-value");
                        var series = $(".series-value");
                        if (type === "fixed") {
                            fixed.show();
                            fixed.find("input").prop('disabled', false);
                            series.hide();
                            series.find("input").prop('disabled', true);
                            series.find("select").prop('disabled', true);
                            series.find("select").removeClass("required");
                        } else if (type === "series") {
                            series.show();
                            series.find("input").prop('disabled', false);
                            series.find("select").prop('disabled', false);
                            series.find("select").addClass("required");
                            fixed.hide();
                            fixed.find("input").prop('disabled', true);
                        }
                    });
                })

                flog("levels", $("#levels-table-body .btn-remove-level"));
                $("#levels-table-body").on("click", ".btn-remove-level", function (e) {
                    e.preventDefault();
                    var id = $(e.target).closest("a").attr("href");
                    doDeleteLevel(id);
                });

                $('#modal-reprocess').find('form').forms({
                    callback: function (resp) {
                        Msg.info(resp.messages[0]);
                        $('#modal-reprocess').modal('hide');
                    }
                });

                initRemovePeriods();
                initKpiLevelCsv();
                initQuery();
                initSelectAll();
                initLeaderboard();
                initDelKpiResult();
                initKpiSeriesGraphControls();
                loadKpiSeriesGraphData(window.location.pathname, options, $("#seriesHistogram"), "dateHistogram", {});
                loadKpiSeriesGraphData(window.location.pathname, options, $("#kpiLeaderboard"), "kpiLeaderboard", {});

            });

        </script>
    </body>
</html>